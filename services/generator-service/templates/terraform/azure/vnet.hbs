{{!-- Azure VNet Template --}}
# Azure Virtual Network Configuration
# Generated by Nimbus

terraform {
  required_version = ">= 1.0"

  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 3.0"
    }
  }
}

provider "azurerm" {
  features {}
}

# Resource Group
{{#if createResourceGroup}}
resource "azurerm_resource_group" "{{name}}" {
  name     = "{{#if resourceGroupName}}{{resourceGroupName}}{{else}}rg-{{name}}{{/if}}"
  location = var.location

  tags = var.tags
}
{{/if}}

# Virtual Network
resource "azurerm_virtual_network" "{{name}}" {
  name                = "{{name}}-vnet"
  resource_group_name = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.name{{else}}var.resource_group_name{{/if}}
  location            = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.location{{else}}var.location{{/if}}
  address_space       = ["{{#if addressSpace}}{{addressSpace}}{{else}}10.0.0.0/16{{/if}}"]

  {{#if dnsServers}}
  dns_servers = [{{#each dnsServers}}"{{this}}"{{#unless @last}}, {{/unless}}{{/each}}]
  {{/if}}

  tags = var.tags
}

{{#each subnets}}
# Subnet: {{name}}
resource "azurerm_subnet" "{{name}}" {
  name                 = "{{name}}"
  resource_group_name  = {{#if ../createResourceGroup}}azurerm_resource_group.{{../name}}.name{{else}}var.resource_group_name{{/if}}
  virtual_network_name = azurerm_virtual_network.{{../name}}.name
  address_prefixes     = ["{{cidr}}"]

  {{#if serviceEndpoints}}
  service_endpoints = [{{#each serviceEndpoints}}"{{this}}"{{#unless @last}}, {{/unless}}{{/each}}]
  {{/if}}

  {{#if delegations}}
  {{#each delegations}}
  delegation {
    name = "{{name}}"
    service_delegation {
      name    = "{{serviceName}}"
      actions = [{{#each actions}}"{{this}}"{{#unless @last}}, {{/unless}}{{/each}}]
    }
  }
  {{/each}}
  {{/if}}

  {{#if privateEndpointNetworkPoliciesEnabled}}
  private_endpoint_network_policies_enabled = true
  {{/if}}
}
{{/each}}

{{#if enableNat}}
# Public IP for NAT Gateway
resource "azurerm_public_ip" "{{name}}_nat" {
  name                = "{{name}}-nat-pip"
  resource_group_name = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.name{{else}}var.resource_group_name{{/if}}
  location            = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.location{{else}}var.location{{/if}}
  allocation_method   = "Static"
  sku                 = "Standard"

  tags = var.tags
}

# NAT Gateway
resource "azurerm_nat_gateway" "{{name}}" {
  name                    = "{{name}}-nat"
  resource_group_name     = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.name{{else}}var.resource_group_name{{/if}}
  location                = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.location{{else}}var.location{{/if}}
  sku_name                = "Standard"
  idle_timeout_in_minutes = 10

  tags = var.tags
}

resource "azurerm_nat_gateway_public_ip_association" "{{name}}" {
  nat_gateway_id       = azurerm_nat_gateway.{{name}}.id
  public_ip_address_id = azurerm_public_ip.{{name}}_nat.id
}

{{#each subnets}}
{{#if associateNat}}
resource "azurerm_subnet_nat_gateway_association" "{{name}}" {
  subnet_id      = azurerm_subnet.{{name}}.id
  nat_gateway_id = azurerm_nat_gateway.{{../name}}.id
}
{{/if}}
{{/each}}
{{/if}}

{{#if enableNsg}}
# Network Security Group
resource "azurerm_network_security_group" "{{name}}" {
  name                = "{{name}}-nsg"
  resource_group_name = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.name{{else}}var.resource_group_name{{/if}}
  location            = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.location{{else}}var.location{{/if}}

  {{#each nsgRules}}
  security_rule {
    name                       = "{{name}}"
    priority                   = {{priority}}
    direction                  = "{{direction}}"
    access                     = "{{access}}"
    protocol                   = "{{protocol}}"
    source_port_range          = "{{sourcePortRange}}"
    destination_port_range     = "{{destinationPortRange}}"
    source_address_prefix      = "{{sourceAddressPrefix}}"
    destination_address_prefix = "{{destinationAddressPrefix}}"
  }
  {{/each}}

  tags = var.tags
}

{{#each subnets}}
{{#if associateNsg}}
resource "azurerm_subnet_network_security_group_association" "{{name}}" {
  subnet_id                 = azurerm_subnet.{{name}}.id
  network_security_group_id = azurerm_network_security_group.{{../name}}.id
}
{{/if}}
{{/each}}
{{/if}}

{{#if enableBastionHost}}
# Azure Bastion
resource "azurerm_subnet" "bastion" {
  name                 = "AzureBastionSubnet"
  resource_group_name  = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.name{{else}}var.resource_group_name{{/if}}
  virtual_network_name = azurerm_virtual_network.{{name}}.name
  address_prefixes     = ["{{#if bastionSubnetCidr}}{{bastionSubnetCidr}}{{else}}10.0.255.0/26{{/if}}"]
}

resource "azurerm_public_ip" "bastion" {
  name                = "{{name}}-bastion-pip"
  resource_group_name = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.name{{else}}var.resource_group_name{{/if}}
  location            = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.location{{else}}var.location{{/if}}
  allocation_method   = "Static"
  sku                 = "Standard"

  tags = var.tags
}

resource "azurerm_bastion_host" "{{name}}" {
  name                = "{{name}}-bastion"
  resource_group_name = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.name{{else}}var.resource_group_name{{/if}}
  location            = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.location{{else}}var.location{{/if}}

  ip_configuration {
    name                 = "configuration"
    subnet_id            = azurerm_subnet.bastion.id
    public_ip_address_id = azurerm_public_ip.bastion.id
  }

  tags = var.tags
}
{{/if}}

# Variables
variable "location" {
  description = "Azure region"
  type        = string
  default     = "{{#if location}}{{location}}{{else}}eastus{{/if}}"
}

{{#unless createResourceGroup}}
variable "resource_group_name" {
  description = "Resource group name"
  type        = string
}
{{/unless}}

variable "tags" {
  description = "Tags to apply to resources"
  type        = map(string)
  default     = {}
}

# Outputs
{{#if createResourceGroup}}
output "resource_group_name" {
  description = "Resource group name"
  value       = azurerm_resource_group.{{name}}.name
}
{{/if}}

output "vnet_id" {
  description = "VNet ID"
  value       = azurerm_virtual_network.{{name}}.id
}

output "vnet_name" {
  description = "VNet name"
  value       = azurerm_virtual_network.{{name}}.name
}

{{#each subnets}}
output "{{name}}_subnet_id" {
  description = "{{name}} subnet ID"
  value       = azurerm_subnet.{{name}}.id
}
{{/each}}
