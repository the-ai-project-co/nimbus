{{!-- Azure AKS Template --}}
# Azure Kubernetes Service Configuration
# Generated by Nimbus

terraform {
  required_version = ">= 1.0"

  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 3.0"
    }
    azuread = {
      source  = "hashicorp/azuread"
      version = "~> 2.0"
    }
  }
}

provider "azurerm" {
  features {}
}

{{#if createResourceGroup}}
# Resource Group
resource "azurerm_resource_group" "{{name}}" {
  name     = "{{#if resourceGroupName}}{{resourceGroupName}}{{else}}rg-{{name}}{{/if}}"
  location = var.location

  tags = var.tags
}
{{/if}}

# AKS Cluster
resource "azurerm_kubernetes_cluster" "{{name}}" {
  name                = "{{name}}"
  location            = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.location{{else}}var.location{{/if}}
  resource_group_name = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.name{{else}}var.resource_group_name{{/if}}
  dns_prefix          = "{{#if dnsPrefix}}{{dnsPrefix}}{{else}}{{name}}{{/if}}"
  kubernetes_version  = "{{#if kubernetesVersion}}{{kubernetesVersion}}{{else}}1.28{{/if}}"

  {{#if privateCluster}}
  private_cluster_enabled = true
  {{/if}}

  default_node_pool {
    name                = "{{#if defaultNodePool.name}}{{defaultNodePool.name}}{{else}}default{{/if}}"
    node_count          = {{#if defaultNodePool.nodeCount}}{{defaultNodePool.nodeCount}}{{else}}3{{/if}}
    vm_size             = "{{#if defaultNodePool.vmSize}}{{defaultNodePool.vmSize}}{{else}}Standard_D2s_v3{{/if}}"
    os_disk_size_gb     = {{#if defaultNodePool.osDiskSizeGb}}{{defaultNodePool.osDiskSizeGb}}{{else}}128{{/if}}
    os_disk_type        = "{{#if defaultNodePool.osDiskType}}{{defaultNodePool.osDiskType}}{{else}}Managed{{/if}}"
    type                = "VirtualMachineScaleSets"
    enable_auto_scaling = {{#if defaultNodePool.enableAutoScaling}}true{{else}}true{{/if}}
    min_count           = {{#if defaultNodePool.minCount}}{{defaultNodePool.minCount}}{{else}}1{{/if}}
    max_count           = {{#if defaultNodePool.maxCount}}{{defaultNodePool.maxCount}}{{else}}10{{/if}}

    {{#if vnetSubnetId}}
    vnet_subnet_id = {{vnetSubnetId}}
    {{else if subnetName}}
    vnet_subnet_id = azurerm_subnet.{{subnetName}}.id
    {{/if}}

    {{#if defaultNodePool.nodeLabels}}
    node_labels = {
      {{#each defaultNodePool.nodeLabels}}
      "{{@key}}" = "{{this}}"
      {{/each}}
    }
    {{/if}}

    {{#if defaultNodePool.nodeTaints}}
    node_taints = [{{#each defaultNodePool.nodeTaints}}"{{this}}"{{#unless @last}}, {{/unless}}{{/each}}]
    {{/if}}

    {{#if defaultNodePool.zones}}
    zones = [{{#each defaultNodePool.zones}}"{{this}}"{{#unless @last}}, {{/unless}}{{/each}}]
    {{/if}}

    tags = var.tags
  }

  identity {
    type = "{{#if identityType}}{{identityType}}{{else}}SystemAssigned{{/if}}"
  }

  {{#if enableRbac}}
  azure_active_directory_role_based_access_control {
    managed                = true
    azure_rbac_enabled     = true
    {{#if adminGroupObjectIds}}
    admin_group_object_ids = [{{#each adminGroupObjectIds}}"{{this}}"{{#unless @last}}, {{/unless}}{{/each}}]
    {{/if}}
  }
  {{/if}}

  network_profile {
    network_plugin     = "{{#if networkPlugin}}{{networkPlugin}}{{else}}azure{{/if}}"
    network_policy     = "{{#if networkPolicy}}{{networkPolicy}}{{else}}calico{{/if}}"
    load_balancer_sku  = "standard"
    outbound_type      = "{{#if outboundType}}{{outboundType}}{{else}}loadBalancer{{/if}}"
    {{#if serviceCidr}}
    service_cidr       = "{{serviceCidr}}"
    {{/if}}
    {{#if dnsServiceIp}}
    dns_service_ip     = "{{dnsServiceIp}}"
    {{/if}}
    {{#if dockerBridgeCidr}}
    docker_bridge_cidr = "{{dockerBridgeCidr}}"
    {{/if}}
  }

  {{#if enableMonitoring}}
  oms_agent {
    log_analytics_workspace_id = {{#if logAnalyticsWorkspaceId}}{{logAnalyticsWorkspaceId}}{{else}}azurerm_log_analytics_workspace.{{name}}.id{{/if}}
  }
  {{/if}}

  {{#if enableKeyVaultSecretsProvider}}
  key_vault_secrets_provider {
    secret_rotation_enabled  = true
    secret_rotation_interval = "2m"
  }
  {{/if}}

  {{#if enableOidcIssuer}}
  oidc_issuer_enabled = true
  {{/if}}

  {{#if enableWorkloadIdentity}}
  workload_identity_enabled = true
  {{/if}}

  {{#if maintenanceWindow}}
  maintenance_window {
    allowed {
      day   = "{{maintenanceWindow.day}}"
      hours = [{{#each maintenanceWindow.hours}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}]
    }
  }
  {{/if}}

  auto_scaler_profile {
    balance_similar_node_groups      = true
    expander                         = "random"
    max_graceful_termination_sec     = 600
    max_node_provisioning_time       = "15m"
    max_unready_nodes                = 3
    max_unready_percentage           = 45
    new_pod_scale_up_delay           = "10s"
    scale_down_delay_after_add       = "10m"
    scale_down_delay_after_delete    = "10s"
    scale_down_delay_after_failure   = "3m"
    scan_interval                    = "10s"
    scale_down_unneeded              = "10m"
    scale_down_unready               = "20m"
    scale_down_utilization_threshold = 0.5
  }

  tags = var.tags
}

{{#each additionalNodePools}}
# Additional Node Pool: {{name}}
resource "azurerm_kubernetes_cluster_node_pool" "{{name}}" {
  name                  = "{{name}}"
  kubernetes_cluster_id = azurerm_kubernetes_cluster.{{../name}}.id
  vm_size               = "{{#if vmSize}}{{vmSize}}{{else}}Standard_D2s_v3{{/if}}"
  node_count            = {{#if nodeCount}}{{nodeCount}}{{else}}1{{/if}}
  enable_auto_scaling   = {{#if enableAutoScaling}}true{{else}}true{{/if}}
  min_count             = {{#if minCount}}{{minCount}}{{else}}1{{/if}}
  max_count             = {{#if maxCount}}{{maxCount}}{{else}}10{{/if}}
  os_disk_size_gb       = {{#if osDiskSizeGb}}{{osDiskSizeGb}}{{else}}128{{/if}}
  os_type               = "{{#if osType}}{{osType}}{{else}}Linux{{/if}}"
  mode                  = "{{#if mode}}{{mode}}{{else}}User{{/if}}"

  {{#if vnetSubnetId}}
  vnet_subnet_id = {{vnetSubnetId}}
  {{/if}}

  {{#if nodeLabels}}
  node_labels = {
    {{#each nodeLabels}}
    "{{@key}}" = "{{this}}"
    {{/each}}
  }
  {{/if}}

  {{#if nodeTaints}}
  node_taints = [{{#each nodeTaints}}"{{this}}"{{#unless @last}}, {{/unless}}{{/each}}]
  {{/if}}

  {{#if zones}}
  zones = [{{#each zones}}"{{this}}"{{#unless @last}}, {{/unless}}{{/each}}]
  {{/if}}

  {{#if spot}}
  priority        = "Spot"
  eviction_policy = "Delete"
  spot_max_price  = {{#if spotMaxPrice}}{{spotMaxPrice}}{{else}}-1{{/if}}
  {{/if}}

  tags = var.tags
}
{{/each}}

{{#if enableMonitoring}}
{{#unless logAnalyticsWorkspaceId}}
# Log Analytics Workspace
resource "azurerm_log_analytics_workspace" "{{name}}" {
  name                = "{{name}}-logs"
  resource_group_name = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.name{{else}}var.resource_group_name{{/if}}
  location            = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.location{{else}}var.location{{/if}}
  sku                 = "PerGB2018"
  retention_in_days   = {{#if logRetentionDays}}{{logRetentionDays}}{{else}}30{{/if}}

  tags = var.tags
}
{{/unless}}
{{/if}}

{{#if enableContainerRegistry}}
# Azure Container Registry
resource "azurerm_container_registry" "{{name}}" {
  name                = "{{#if acrName}}{{acrName}}{{else}}{{name}}acr{{/if}}"
  resource_group_name = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.name{{else}}var.resource_group_name{{/if}}
  location            = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.location{{else}}var.location{{/if}}
  sku                 = "{{#if acrSku}}{{acrSku}}{{else}}Standard{{/if}}"
  admin_enabled       = false

  tags = var.tags
}

# ACR Pull Role Assignment
resource "azurerm_role_assignment" "{{name}}_acr_pull" {
  principal_id                     = azurerm_kubernetes_cluster.{{name}}.kubelet_identity[0].object_id
  role_definition_name             = "AcrPull"
  scope                            = azurerm_container_registry.{{name}}.id
  skip_service_principal_aad_check = true
}
{{/if}}

# Variables
variable "location" {
  description = "Azure region"
  type        = string
  default     = "{{#if location}}{{location}}{{else}}eastus{{/if}}"
}

{{#unless createResourceGroup}}
variable "resource_group_name" {
  description = "Resource group name"
  type        = string
}
{{/unless}}

variable "tags" {
  description = "Tags to apply to resources"
  type        = map(string)
  default     = {}
}

# Outputs
output "cluster_id" {
  description = "AKS cluster ID"
  value       = azurerm_kubernetes_cluster.{{name}}.id
}

output "cluster_name" {
  description = "AKS cluster name"
  value       = azurerm_kubernetes_cluster.{{name}}.name
}

output "cluster_fqdn" {
  description = "AKS cluster FQDN"
  value       = azurerm_kubernetes_cluster.{{name}}.fqdn
}

output "kube_config" {
  description = "Kubernetes configuration"
  value       = azurerm_kubernetes_cluster.{{name}}.kube_config_raw
  sensitive   = true
}

output "kubelet_identity" {
  description = "Kubelet managed identity"
  value       = azurerm_kubernetes_cluster.{{name}}.kubelet_identity[0].object_id
}

{{#if enableOidcIssuer}}
output "oidc_issuer_url" {
  description = "OIDC issuer URL for workload identity"
  value       = azurerm_kubernetes_cluster.{{name}}.oidc_issuer_url
}
{{/if}}

{{#if enableContainerRegistry}}
output "acr_login_server" {
  description = "ACR login server"
  value       = azurerm_container_registry.{{name}}.login_server
}
{{/if}}

output "get_credentials_command" {
  description = "Command to get kubectl credentials"
  value       = "az aks get-credentials --resource-group ${{{#if createResourceGroup}}azurerm_resource_group.{{name}}.name{{else}}var.resource_group_name{{/if}}} --name {{name}}"
}
