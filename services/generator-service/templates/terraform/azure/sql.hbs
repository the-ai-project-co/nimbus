{{!-- Azure SQL Database Template --}}
# Azure SQL Database Configuration
# Generated by Nimbus

terraform {
  required_version = ">= 1.0"

  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 3.0"
    }
    random = {
      source  = "hashicorp/random"
      version = "~> 3.0"
    }
  }
}

provider "azurerm" {
  features {}
}

{{#if createResourceGroup}}
# Resource Group
resource "azurerm_resource_group" "{{name}}" {
  name     = "{{#if resourceGroupName}}{{resourceGroupName}}{{else}}rg-{{name}}{{/if}}"
  location = var.location

  tags = var.tags
}
{{/if}}

# Random password for admin
resource "random_password" "{{name}}_admin" {
  length           = 32
  special          = true
  override_special = "!#$%&*()-_=+[]{}<>:?"
}

# SQL Server
resource "azurerm_mssql_server" "{{name}}" {
  name                         = "{{name}}-sqlserver"
  resource_group_name          = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.name{{else}}var.resource_group_name{{/if}}
  location                     = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.location{{else}}var.location{{/if}}
  version                      = "{{#if sqlVersion}}{{sqlVersion}}{{else}}12.0{{/if}}"
  administrator_login          = "{{#if adminUsername}}{{adminUsername}}{{else}}sqladmin{{/if}}"
  administrator_login_password = random_password.{{name}}_admin.result
  minimum_tls_version          = "{{#if minimumTlsVersion}}{{minimumTlsVersion}}{{else}}1.2{{/if}}"

  {{#if publicNetworkAccessEnabled}}
  public_network_access_enabled = true
  {{else}}
  public_network_access_enabled = false
  {{/if}}

  {{#if enableAzureADAuth}}
  azuread_administrator {
    login_username = "{{azureADAdmin.loginUsername}}"
    object_id      = "{{azureADAdmin.objectId}}"
  }
  {{/if}}

  identity {
    type = "SystemAssigned"
  }

  tags = var.tags
}

# SQL Database
resource "azurerm_mssql_database" "{{name}}" {
  name           = "{{#if databaseName}}{{databaseName}}{{else}}{{name}}{{/if}}"
  server_id      = azurerm_mssql_server.{{name}}.id
  collation      = "{{#if collation}}{{collation}}{{else}}SQL_Latin1_General_CP1_CI_AS{{/if}}"
  license_type   = "{{#if licenseType}}{{licenseType}}{{else}}LicenseIncluded{{/if}}"
  max_size_gb    = {{#if maxSizeGb}}{{maxSizeGb}}{{else}}32{{/if}}
  sku_name       = "{{#if skuName}}{{skuName}}{{else}}S0{{/if}}"
  zone_redundant = {{#if zoneRedundant}}true{{else}}false{{/if}}

  {{#if elasticPoolId}}
  elastic_pool_id = {{elasticPoolId}}
  {{/if}}

  {{#if readScale}}
  read_scale = true
  {{/if}}

  {{#if shortTermRetentionPolicy}}
  short_term_retention_policy {
    retention_days           = {{#if shortTermRetentionPolicy.retentionDays}}{{shortTermRetentionPolicy.retentionDays}}{{else}}7{{/if}}
    backup_interval_in_hours = {{#if shortTermRetentionPolicy.backupInterval}}{{shortTermRetentionPolicy.backupInterval}}{{else}}12{{/if}}
  }
  {{/if}}

  {{#if longTermRetentionPolicy}}
  long_term_retention_policy {
    weekly_retention  = "{{#if longTermRetentionPolicy.weekly}}{{longTermRetentionPolicy.weekly}}{{else}}P1W{{/if}}"
    monthly_retention = "{{#if longTermRetentionPolicy.monthly}}{{longTermRetentionPolicy.monthly}}{{else}}P1M{{/if}}"
    yearly_retention  = "{{#if longTermRetentionPolicy.yearly}}{{longTermRetentionPolicy.yearly}}{{else}}P1Y{{/if}}"
    week_of_year      = {{#if longTermRetentionPolicy.weekOfYear}}{{longTermRetentionPolicy.weekOfYear}}{{else}}1{{/if}}
  }
  {{/if}}

  {{#if threatDetectionPolicy}}
  threat_detection_policy {
    state                      = "Enabled"
    email_addresses            = [{{#each threatDetectionPolicy.emailAddresses}}"{{this}}"{{#unless @last}}, {{/unless}}{{/each}}]
    email_account_admins       = {{#if threatDetectionPolicy.emailAccountAdmins}}true{{else}}false{{/if}}
    retention_days             = {{#if threatDetectionPolicy.retentionDays}}{{threatDetectionPolicy.retentionDays}}{{else}}30{{/if}}
  }
  {{/if}}

  tags = var.tags
}

{{#each additionalDatabases}}
# Additional Database: {{name}}
resource "azurerm_mssql_database" "{{name}}" {
  name         = "{{name}}"
  server_id    = azurerm_mssql_server.{{../name}}.id
  collation    = "{{#if collation}}{{collation}}{{else}}SQL_Latin1_General_CP1_CI_AS{{/if}}"
  license_type = "{{#if licenseType}}{{licenseType}}{{else}}LicenseIncluded{{/if}}"
  max_size_gb  = {{#if maxSizeGb}}{{maxSizeGb}}{{else}}32{{/if}}
  sku_name     = "{{#if skuName}}{{skuName}}{{else}}S0{{/if}}"

  tags = var.tags
}
{{/each}}

{{#if publicNetworkAccessEnabled}}
{{#each firewallRules}}
# Firewall Rule: {{name}}
resource "azurerm_mssql_firewall_rule" "{{../name}}_{{name}}" {
  name             = "{{name}}"
  server_id        = azurerm_mssql_server.{{../name}}.id
  start_ip_address = "{{startIpAddress}}"
  end_ip_address   = "{{endIpAddress}}"
}
{{/each}}

{{#if allowAzureServices}}
# Allow Azure Services
resource "azurerm_mssql_firewall_rule" "{{name}}_azure_services" {
  name             = "AllowAzureServices"
  server_id        = azurerm_mssql_server.{{name}}.id
  start_ip_address = "0.0.0.0"
  end_ip_address   = "0.0.0.0"
}
{{/if}}
{{/if}}

{{#if enablePrivateEndpoint}}
# Private Endpoint
resource "azurerm_private_endpoint" "{{name}}" {
  name                = "{{name}}-pe"
  resource_group_name = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.name{{else}}var.resource_group_name{{/if}}
  location            = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.location{{else}}var.location{{/if}}
  subnet_id           = {{#if privateEndpointSubnetId}}{{privateEndpointSubnetId}}{{else}}var.private_endpoint_subnet_id{{/if}}

  private_service_connection {
    name                           = "{{name}}-privateserviceconnection"
    private_connection_resource_id = azurerm_mssql_server.{{name}}.id
    subresource_names              = ["sqlServer"]
    is_manual_connection           = false
  }

  {{#if privateDnsZoneId}}
  private_dns_zone_group {
    name                 = "{{name}}-dzg"
    private_dns_zone_ids = [{{privateDnsZoneId}}]
  }
  {{/if}}

  tags = var.tags
}
{{/if}}

{{#if enableAuditing}}
# Storage Account for Auditing
resource "azurerm_storage_account" "{{name}}_audit" {
  name                     = "{{#if auditStorageAccountName}}{{auditStorageAccountName}}{{else}}{{name}}audit{{/if}}"
  resource_group_name      = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.name{{else}}var.resource_group_name{{/if}}
  location                 = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.location{{else}}var.location{{/if}}
  account_tier             = "Standard"
  account_replication_type = "LRS"
  min_tls_version          = "TLS1_2"

  tags = var.tags
}

# Extended Auditing Policy
resource "azurerm_mssql_server_extended_auditing_policy" "{{name}}" {
  server_id                               = azurerm_mssql_server.{{name}}.id
  storage_endpoint                        = azurerm_storage_account.{{name}}_audit.primary_blob_endpoint
  storage_account_access_key              = azurerm_storage_account.{{name}}_audit.primary_access_key
  storage_account_access_key_is_secondary = false
  retention_in_days                       = {{#if auditRetentionDays}}{{auditRetentionDays}}{{else}}90{{/if}}
}
{{/if}}

{{#if storeCredentialsInKeyVault}}
# Store credentials in Key Vault
resource "azurerm_key_vault_secret" "{{name}}_connection_string" {
  name         = "{{name}}-sql-connection-string"
  value        = "Server=tcp:${azurerm_mssql_server.{{name}}.fully_qualified_domain_name},1433;Initial Catalog=${azurerm_mssql_database.{{name}}.name};Persist Security Info=False;User ID=${azurerm_mssql_server.{{name}}.administrator_login};Password=${random_password.{{name}}_admin.result};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"
  key_vault_id = {{keyVaultId}}
}
{{/if}}

# Variables
variable "location" {
  description = "Azure region"
  type        = string
  default     = "{{#if location}}{{location}}{{else}}eastus{{/if}}"
}

{{#unless createResourceGroup}}
variable "resource_group_name" {
  description = "Resource group name"
  type        = string
}
{{/unless}}

{{#if enablePrivateEndpoint}}
{{#unless privateEndpointSubnetId}}
variable "private_endpoint_subnet_id" {
  description = "Subnet ID for private endpoint"
  type        = string
}
{{/unless}}
{{/if}}

variable "tags" {
  description = "Tags to apply to resources"
  type        = map(string)
  default     = {}
}

# Outputs
output "server_id" {
  description = "SQL Server ID"
  value       = azurerm_mssql_server.{{name}}.id
}

output "server_fqdn" {
  description = "SQL Server FQDN"
  value       = azurerm_mssql_server.{{name}}.fully_qualified_domain_name
}

output "database_id" {
  description = "Database ID"
  value       = azurerm_mssql_database.{{name}}.id
}

output "database_name" {
  description = "Database name"
  value       = azurerm_mssql_database.{{name}}.name
}

output "admin_username" {
  description = "Admin username"
  value       = azurerm_mssql_server.{{name}}.administrator_login
}

output "admin_password" {
  description = "Admin password"
  value       = random_password.{{name}}_admin.result
  sensitive   = true
}

output "connection_string" {
  description = "Connection string (without password)"
  value       = "Server=tcp:${azurerm_mssql_server.{{name}}.fully_qualified_domain_name},1433;Initial Catalog=${azurerm_mssql_database.{{name}}.name};Persist Security Info=False;User ID=${azurerm_mssql_server.{{name}}.administrator_login};MultipleActiveResultSets=False;Encrypt=True;TrustServerCertificate=False;Connection Timeout=30;"
}
