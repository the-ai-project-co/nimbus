{{!-- Azure Storage Account Template --}}
# Azure Storage Account Configuration
# Generated by Nimbus

terraform {
  required_version = ">= 1.0"

  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 3.0"
    }
  }
}

provider "azurerm" {
  features {}
}

{{#if createResourceGroup}}
# Resource Group
resource "azurerm_resource_group" "{{name}}" {
  name     = "{{#if resourceGroupName}}{{resourceGroupName}}{{else}}rg-{{name}}{{/if}}"
  location = var.location

  tags = var.tags
}
{{/if}}

# Storage Account
resource "azurerm_storage_account" "{{name}}" {
  name                     = "{{#if accountName}}{{accountName}}{{else}}{{name}}storage{{/if}}"
  resource_group_name      = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.name{{else}}var.resource_group_name{{/if}}
  location                 = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.location{{else}}var.location{{/if}}
  account_tier             = "{{#if accountTier}}{{accountTier}}{{else}}Standard{{/if}}"
  account_replication_type = "{{#if accountReplicationType}}{{accountReplicationType}}{{else}}LRS{{/if}}"
  account_kind             = "{{#if accountKind}}{{accountKind}}{{else}}StorageV2{{/if}}"
  access_tier              = "{{#if accessTier}}{{accessTier}}{{else}}Hot{{/if}}"

  min_tls_version                 = "{{#if minTlsVersion}}{{minTlsVersion}}{{else}}TLS1_2{{/if}}"
  enable_https_traffic_only       = true
  allow_nested_items_to_be_public = {{#if allowPublicAccess}}true{{else}}false{{/if}}

  {{#if enableHierarchicalNamespace}}
  is_hns_enabled = true
  {{/if}}

  {{#if enableNfsV3}}
  nfsv3_enabled = true
  {{/if}}

  {{#if enableLargeFileShare}}
  large_file_share_enabled = true
  {{/if}}

  {{#if enableBlobVersioning}}
  blob_properties {
    versioning_enabled = true

    {{#if enableSoftDelete}}
    delete_retention_policy {
      days = {{#if softDeleteRetentionDays}}{{softDeleteRetentionDays}}{{else}}7{{/if}}
    }

    container_delete_retention_policy {
      days = {{#if containerSoftDeleteRetentionDays}}{{containerSoftDeleteRetentionDays}}{{else}}7{{/if}}
    }
    {{/if}}

    {{#if enablePointInTimeRestore}}
    restore_policy {
      days = {{#if restoreDays}}{{restoreDays}}{{else}}6{{/if}}
    }
    {{/if}}

    {{#if enableChangeFeed}}
    change_feed_enabled = true
    {{#if changeFeedRetentionDays}}
    change_feed_retention_in_days = {{changeFeedRetentionDays}}
    {{/if}}
    {{/if}}
  }
  {{/if}}

  {{#if networkRules}}
  network_rules {
    default_action             = "{{#if networkRules.defaultAction}}{{networkRules.defaultAction}}{{else}}Deny{{/if}}"
    ip_rules                   = [{{#each networkRules.ipRules}}"{{this}}"{{#unless @last}}, {{/unless}}{{/each}}]
    virtual_network_subnet_ids = [{{#each networkRules.subnetIds}}{{this}}{{#unless @last}}, {{/unless}}{{/each}}]
    bypass                     = [{{#each networkRules.bypass}}"{{this}}"{{#unless @last}}, {{/unless}}{{/each}}]
  }
  {{/if}}

  {{#if enableStaticWebsite}}
  static_website {
    index_document     = "{{#if staticWebsite.indexDocument}}{{staticWebsite.indexDocument}}{{else}}index.html{{/if}}"
    error_404_document = "{{#if staticWebsite.error404Document}}{{staticWebsite.error404Document}}{{else}}404.html{{/if}}"
  }
  {{/if}}

  {{#if customDomain}}
  custom_domain {
    name          = "{{customDomain.name}}"
    use_subdomain = {{#if customDomain.useSubdomain}}true{{else}}false{{/if}}
  }
  {{/if}}

  identity {
    type = "SystemAssigned"
  }

  tags = var.tags
}

{{#each containers}}
# Blob Container: {{name}}
resource "azurerm_storage_container" "{{name}}" {
  name                  = "{{name}}"
  storage_account_name  = azurerm_storage_account.{{../name}}.name
  container_access_type = "{{#if accessType}}{{accessType}}{{else}}private{{/if}}"
}
{{/each}}

{{#each fileShares}}
# File Share: {{name}}
resource "azurerm_storage_share" "{{name}}" {
  name                 = "{{name}}"
  storage_account_name = azurerm_storage_account.{{../name}}.name
  quota                = {{#if quotaGb}}{{quotaGb}}{{else}}50{{/if}}
  access_tier          = "{{#if accessTier}}{{accessTier}}{{else}}TransactionOptimized{{/if}}"
}
{{/each}}

{{#each queues}}
# Queue: {{name}}
resource "azurerm_storage_queue" "{{name}}" {
  name                 = "{{name}}"
  storage_account_name = azurerm_storage_account.{{../name}}.name
}
{{/each}}

{{#each tables}}
# Table: {{name}}
resource "azurerm_storage_table" "{{name}}" {
  name                 = "{{name}}"
  storage_account_name = azurerm_storage_account.{{../name}}.name
}
{{/each}}

{{#if enablePrivateEndpoint}}
# Private Endpoint for Blob
resource "azurerm_private_endpoint" "{{name}}_blob" {
  name                = "{{name}}-blob-pe"
  resource_group_name = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.name{{else}}var.resource_group_name{{/if}}
  location            = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.location{{else}}var.location{{/if}}
  subnet_id           = {{#if privateEndpointSubnetId}}{{privateEndpointSubnetId}}{{else}}var.private_endpoint_subnet_id{{/if}}

  private_service_connection {
    name                           = "{{name}}-blob-psc"
    private_connection_resource_id = azurerm_storage_account.{{name}}.id
    subresource_names              = ["blob"]
    is_manual_connection           = false
  }

  tags = var.tags
}

{{#if enableFilePrivateEndpoint}}
# Private Endpoint for File
resource "azurerm_private_endpoint" "{{name}}_file" {
  name                = "{{name}}-file-pe"
  resource_group_name = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.name{{else}}var.resource_group_name{{/if}}
  location            = {{#if createResourceGroup}}azurerm_resource_group.{{name}}.location{{else}}var.location{{/if}}
  subnet_id           = {{#if privateEndpointSubnetId}}{{privateEndpointSubnetId}}{{else}}var.private_endpoint_subnet_id{{/if}}

  private_service_connection {
    name                           = "{{name}}-file-psc"
    private_connection_resource_id = azurerm_storage_account.{{name}}.id
    subresource_names              = ["file"]
    is_manual_connection           = false
  }

  tags = var.tags
}
{{/if}}
{{/if}}

{{#if enableManagementPolicy}}
# Lifecycle Management Policy
resource "azurerm_storage_management_policy" "{{name}}" {
  storage_account_id = azurerm_storage_account.{{name}}.id

  {{#each lifecycleRules}}
  rule {
    name    = "{{name}}"
    enabled = true

    filters {
      prefix_match = [{{#each prefixMatch}}"{{this}}"{{#unless @last}}, {{/unless}}{{/each}}]
      blob_types   = [{{#each blobTypes}}"{{this}}"{{#unless @last}}, {{/unless}}{{/each}}]
    }

    actions {
      {{#if tierToCool}}
      base_blob {
        tier_to_cool_after_days_since_modification_greater_than = {{tierToCool}}
      }
      {{/if}}
      {{#if tierToArchive}}
      base_blob {
        tier_to_archive_after_days_since_modification_greater_than = {{tierToArchive}}
      }
      {{/if}}
      {{#if delete}}
      base_blob {
        delete_after_days_since_modification_greater_than = {{delete}}
      }
      {{/if}}
      {{#if snapshotDelete}}
      snapshot {
        delete_after_days_since_creation_greater_than = {{snapshotDelete}}
      }
      {{/if}}
    }
  }
  {{/each}}
}
{{/if}}

# Variables
variable "location" {
  description = "Azure region"
  type        = string
  default     = "{{#if location}}{{location}}{{else}}eastus{{/if}}"
}

{{#unless createResourceGroup}}
variable "resource_group_name" {
  description = "Resource group name"
  type        = string
}
{{/unless}}

{{#if enablePrivateEndpoint}}
{{#unless privateEndpointSubnetId}}
variable "private_endpoint_subnet_id" {
  description = "Subnet ID for private endpoint"
  type        = string
}
{{/unless}}
{{/if}}

variable "tags" {
  description = "Tags to apply to resources"
  type        = map(string)
  default     = {}
}

# Outputs
output "storage_account_id" {
  description = "Storage account ID"
  value       = azurerm_storage_account.{{name}}.id
}

output "storage_account_name" {
  description = "Storage account name"
  value       = azurerm_storage_account.{{name}}.name
}

output "primary_blob_endpoint" {
  description = "Primary blob endpoint"
  value       = azurerm_storage_account.{{name}}.primary_blob_endpoint
}

output "primary_file_endpoint" {
  description = "Primary file endpoint"
  value       = azurerm_storage_account.{{name}}.primary_file_endpoint
}

output "primary_connection_string" {
  description = "Primary connection string"
  value       = azurerm_storage_account.{{name}}.primary_connection_string
  sensitive   = true
}

output "primary_access_key" {
  description = "Primary access key"
  value       = azurerm_storage_account.{{name}}.primary_access_key
  sensitive   = true
}

{{#if enableStaticWebsite}}
output "static_website_url" {
  description = "Static website URL"
  value       = azurerm_storage_account.{{name}}.primary_web_endpoint
}
{{/if}}
