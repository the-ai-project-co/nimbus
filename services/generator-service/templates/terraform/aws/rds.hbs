# RDS Database Configuration for {{project_name}}
# Provider: AWS
# Component: RDS
# Generated by Nimbus Generator Service

terraform {
  required_version = ">= 1.0"

  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
    random = {
      source  = "hashicorp/random"
      version = "~> 3.0"
    }
  }
}

# Random password for database
resource "random_password" "master" {
  length  = 32
  special = true
  override_special = "!#$%&*()-_=+[]{}<>:?"
}

# Store password in AWS Secrets Manager
resource "aws_secretsmanager_secret" "db_password" {
  name                    = "{{project_name}}-{{db_engine}}-master-password"
  description             = "Master password for {{project_name}} {{db_engine}} database"
  recovery_window_in_days = {{secret_recovery_window_days}}

  tags = {{#if tags}}{{tf_map tags}}{{else}}{
    Name        = "{{project_name}}-db-password"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }{{/if}}
}

resource "aws_secretsmanager_secret_version" "db_password" {
  secret_id     = aws_secretsmanager_secret.db_password.id
  secret_string = jsonencode({
    username = "{{db_username}}"
    password = random_password.master.result
    engine   = "{{db_engine}}"
    host     = {{#if create_cluster}}aws_rds_cluster.main[0].endpoint{{else}}aws_db_instance.main[0].address{{/if}}
    port     = {{#if create_cluster}}aws_rds_cluster.main[0].port{{else}}aws_db_instance.main[0].port{{/if}}
    dbname   = "{{db_name}}"
  })
}

# DB Subnet Group
resource "aws_db_subnet_group" "main" {
  name       = "{{project_name}}-db-subnet-group"
  subnet_ids = var.private_subnet_ids

  tags = {{#if tags}}{{tf_map tags}}{{else}}{
    Name        = "{{project_name}}-db-subnet-group"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }{{/if}}
}

# Security Group for RDS
resource "aws_security_group" "rds" {
  name        = "{{project_name}}-rds-sg"
  description = "Security group for RDS database"
  vpc_id      = var.vpc_id

  tags = {{#if tags}}{{tf_map tags}}{{else}}{
    Name        = "{{project_name}}-rds-sg"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }{{/if}}
}

resource "aws_security_group_rule" "rds_ingress" {
  type                     = "ingress"
  from_port                = {{db_port}}
  to_port                  = {{db_port}}
  protocol                 = "tcp"
  source_security_group_id = var.app_security_group_id
  security_group_id        = aws_security_group.rds.id
  description              = "Allow application access to RDS"
}

resource "aws_security_group_rule" "rds_egress" {
  type              = "egress"
  from_port         = 0
  to_port           = 0
  protocol          = "-1"
  cidr_blocks       = ["0.0.0.0/0"]
  security_group_id = aws_security_group.rds.id
  description       = "Allow all egress traffic"
}

# KMS Key for RDS encryption
resource "aws_kms_key" "rds" {
  description             = "KMS key for {{project_name}} RDS encryption"
  deletion_window_in_days = 10
  enable_key_rotation     = true

  tags = {{#if tags}}{{tf_map tags}}{{else}}{
    Name        = "{{project_name}}-rds-key"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }{{/if}}
}

resource "aws_kms_alias" "rds" {
  name          = "alias/{{project_name}}-rds"
  target_key_id = aws_kms_key.rds.key_id
}

# DB Parameter Group
resource "aws_db_parameter_group" "main" {
  count  = {{#if create_cluster}}0{{else}}1{{/if}}
  name   = "{{project_name}}-{{db_engine}}-params"
  family = "{{db_parameter_group_family}}"

  {{#if db_parameters}}
  {{#each db_parameters}}
  parameter {
    name  = "{{this.name}}"
    value = "{{this.value}}"
  }
  {{/each}}
  {{/if}}

  tags = {{#if tags}}{{tf_map tags}}{{else}}{
    Name        = "{{project_name}}-db-params"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }{{/if}}
}

# DB Option Group
resource "aws_db_option_group" "main" {
  count                    = {{#if create_cluster}}0{{else}}1{{/if}}
  name                     = "{{project_name}}-{{db_engine}}-options"
  option_group_description = "Option group for {{project_name}} {{db_engine}}"
  engine_name              = "{{db_engine}}"
  major_engine_version     = "{{db_major_engine_version}}"

  tags = {{#if tags}}{{tf_map tags}}{{else}}{
    Name        = "{{project_name}}-db-options"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }{{/if}}
}

{{#if create_cluster}}
# RDS Cluster Parameter Group (for Aurora)
resource "aws_rds_cluster_parameter_group" "main" {
  name   = "{{project_name}}-{{db_engine}}-cluster-params"
  family = "{{db_parameter_group_family}}"

  {{#if cluster_parameters}}
  {{#each cluster_parameters}}
  parameter {
    name  = "{{this.name}}"
    value = "{{this.value}}"
  }
  {{/each}}
  {{/if}}

  tags = {{#if tags}}{{tf_map tags}}{{else}}{
    Name        = "{{project_name}}-cluster-params"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }{{/if}}
}

# RDS Cluster (Aurora)
resource "aws_rds_cluster" "main" {
  count                           = 1
  cluster_identifier              = "{{project_name}}-{{db_engine}}-cluster"
  engine                          = "{{db_engine}}"
  engine_version                  = "{{db_engine_version}}"
  database_name                   = "{{db_name}}"
  master_username                 = "{{db_username}}"
  master_password                 = random_password.master.result
  db_subnet_group_name            = aws_db_subnet_group.main.name
  db_cluster_parameter_group_name = aws_rds_cluster_parameter_group.main.name
  vpc_security_group_ids          = [aws_security_group.rds.id]

  backup_retention_period      = {{backup_retention_days}}
  preferred_backup_window      = "{{backup_window}}"
  preferred_maintenance_window = "{{maintenance_window}}"

  storage_encrypted   = true
  kms_key_id          = aws_kms_key.rds.arn
  deletion_protection = {{deletion_protection}}
  skip_final_snapshot = {{skip_final_snapshot}}
  final_snapshot_identifier = "{{project_name}}-final-snapshot-${formatdate("YYYY-MM-DD-hhmm", timestamp())}"

  {{#if enable_enhanced_monitoring}}
  enabled_cloudwatch_logs_exports = {{tf_list cloudwatch_log_exports}}
  {{/if}}

  tags = {{#if tags}}{{tf_map tags}}{{else}}{
    Name        = "{{project_name}}-{{db_engine}}-cluster"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }{{/if}}
}

# RDS Cluster Instances
resource "aws_rds_cluster_instance" "main" {
  count                        = {{cluster_instance_count}}
  identifier                   = "{{project_name}}-{{db_engine}}-instance-${count.index + 1}"
  cluster_identifier           = aws_rds_cluster.main[0].id
  instance_class               = "{{db_instance_class}}"
  engine                       = "{{db_engine}}"
  engine_version               = "{{db_engine_version}}"
  publicly_accessible          = false
  auto_minor_version_upgrade   = {{auto_minor_version_upgrade}}
  performance_insights_enabled = {{enable_performance_insights}}
  {{#if enable_performance_insights}}
  performance_insights_kms_key_id      = aws_kms_key.rds.arn
  performance_insights_retention_period = {{performance_insights_retention}}
  {{/if}}

  {{#if enable_enhanced_monitoring}}
  monitoring_interval = 60
  monitoring_role_arn = aws_iam_role.rds_monitoring[0].arn
  {{/if}}

  tags = {{#if tags}}{{tf_map tags}}{{else}}{
    Name        = "{{project_name}}-{{db_engine}}-instance-${count.index + 1}"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }{{/if}}
}
{{else}}
# RDS Instance (Non-Aurora)
resource "aws_db_instance" "main" {
  count                  = 1
  identifier             = "{{project_name}}-{{db_engine}}"
  engine                 = "{{db_engine}}"
  engine_version         = "{{db_engine_version}}"
  instance_class         = "{{db_instance_class}}"
  allocated_storage      = {{db_allocated_storage}}
  max_allocated_storage  = {{db_max_allocated_storage}}
  storage_type           = "{{db_storage_type}}"
  {{#if eq db_storage_type "io1"}}
  iops                   = {{db_iops}}
  {{/if}}
  storage_encrypted      = true
  kms_key_id             = aws_kms_key.rds.arn

  db_name  = "{{db_name}}"
  username = "{{db_username}}"
  password = random_password.master.result
  port     = {{db_port}}

  db_subnet_group_name   = aws_db_subnet_group.main.name
  parameter_group_name   = aws_db_parameter_group.main[0].name
  option_group_name      = aws_db_option_group.main[0].name
  vpc_security_group_ids = [aws_security_group.rds.id]

  backup_retention_period      = {{backup_retention_days}}
  backup_window                = "{{backup_window}}"
  maintenance_window           = "{{maintenance_window}}"
  auto_minor_version_upgrade   = {{auto_minor_version_upgrade}}
  publicly_accessible          = false
  deletion_protection          = {{deletion_protection}}
  skip_final_snapshot          = {{skip_final_snapshot}}
  final_snapshot_identifier    = "{{project_name}}-final-snapshot-${formatdate("YYYY-MM-DD-hhmm", timestamp())}"
  copy_tags_to_snapshot        = true

  {{#if enable_multi_az}}
  multi_az = true
  {{/if}}

  performance_insights_enabled = {{enable_performance_insights}}
  {{#if enable_performance_insights}}
  performance_insights_kms_key_id      = aws_kms_key.rds.arn
  performance_insights_retention_period = {{performance_insights_retention}}
  {{/if}}

  {{#if enable_enhanced_monitoring}}
  monitoring_interval = 60
  monitoring_role_arn = aws_iam_role.rds_monitoring[0].arn
  {{/if}}

  {{#if enable_enhanced_monitoring}}
  enabled_cloudwatch_logs_exports = {{tf_list cloudwatch_log_exports}}
  {{/if}}

  tags = {{#if tags}}{{tf_map tags}}{{else}}{
    Name        = "{{project_name}}-{{db_engine}}"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }{{/if}}
}
{{/if}}

{{#if enable_enhanced_monitoring}}
# IAM Role for Enhanced Monitoring
resource "aws_iam_role" "rds_monitoring" {
  count = 1
  name  = "{{project_name}}-rds-monitoring-role"

  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [
      {
        Action = "sts:AssumeRole"
        Effect = "Allow"
        Principal = {
          Service = "monitoring.rds.amazonaws.com"
        }
      }
    ]
  })

  tags = {{#if tags}}{{tf_map tags}}{{else}}{
    Name        = "{{project_name}}-rds-monitoring-role"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }{{/if}}
}

resource "aws_iam_role_policy_attachment" "rds_monitoring" {
  count      = 1
  role       = aws_iam_role.rds_monitoring[0].name
  policy_arn = "arn:aws:iam::aws:policy/service-role/AmazonRDSEnhancedMonitoringRole"
}
{{/if}}

{{#if create_read_replicas}}
# Read Replicas
resource "aws_db_instance" "replica" {
  count              = {{read_replica_count}}
  identifier         = "{{project_name}}-{{db_engine}}-replica-${count.index + 1}"
  replicate_source_db = aws_db_instance.main[0].identifier
  instance_class     = "{{replica_instance_class}}"
  publicly_accessible = false
  skip_final_snapshot = true
  storage_encrypted   = true
  kms_key_id          = aws_kms_key.rds.arn

  performance_insights_enabled = {{enable_performance_insights}}
  {{#if enable_performance_insights}}
  performance_insights_kms_key_id      = aws_kms_key.rds.arn
  performance_insights_retention_period = {{performance_insights_retention}}
  {{/if}}

  {{#if enable_enhanced_monitoring}}
  monitoring_interval = 60
  monitoring_role_arn = aws_iam_role.rds_monitoring[0].arn
  {{/if}}

  tags = {{#if tags}}{{tf_map tags}}{{else}}{
    Name        = "{{project_name}}-{{db_engine}}-replica-${count.index + 1}"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }{{/if}}
}
{{/if}}

# CloudWatch Alarms
{{#if enable_cloudwatch_alarms}}
resource "aws_cloudwatch_metric_alarm" "cpu" {
  alarm_name          = "{{project_name}}-rds-cpu-utilization"
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = "2"
  metric_name         = "CPUUtilization"
  namespace           = "AWS/RDS"
  period              = "300"
  statistic           = "Average"
  threshold           = "80"
  alarm_description   = "This metric monitors RDS CPU utilization"
  alarm_actions       = {{#if sns_topic_arn}}["{{sns_topic_arn}}"]{{else}}[]{{/if}}

  dimensions = {
    DBInstanceIdentifier = {{#if create_cluster}}aws_rds_cluster_instance.main[0].identifier{{else}}aws_db_instance.main[0].identifier{{/if}}
  }

  tags = {{#if tags}}{{tf_map tags}}{{else}}{
    Name        = "{{project_name}}-rds-cpu-alarm"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }{{/if}}
}

resource "aws_cloudwatch_metric_alarm" "storage" {
  count               = {{#if create_cluster}}0{{else}}1{{/if}}
  alarm_name          = "{{project_name}}-rds-storage-space"
  comparison_operator = "LessThanThreshold"
  evaluation_periods  = "2"
  metric_name         = "FreeStorageSpace"
  namespace           = "AWS/RDS"
  period              = "300"
  statistic           = "Average"
  threshold           = "10000000000" # 10 GB in bytes
  alarm_description   = "This metric monitors RDS free storage space"
  alarm_actions       = {{#if sns_topic_arn}}["{{sns_topic_arn}}"]{{else}}[]{{/if}}

  dimensions = {
    DBInstanceIdentifier = aws_db_instance.main[0].identifier
  }

  tags = {{#if tags}}{{tf_map tags}}{{else}}{
    Name        = "{{project_name}}-rds-storage-alarm"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }{{/if}}
}

resource "aws_cloudwatch_metric_alarm" "memory" {
  alarm_name          = "{{project_name}}-rds-freeable-memory"
  comparison_operator = "LessThanThreshold"
  evaluation_periods  = "2"
  metric_name         = "FreeableMemory"
  namespace           = "AWS/RDS"
  period              = "300"
  statistic           = "Average"
  threshold           = "1000000000" # 1 GB in bytes
  alarm_description   = "This metric monitors RDS freeable memory"
  alarm_actions       = {{#if sns_topic_arn}}["{{sns_topic_arn}}"]{{else}}[]{{/if}}

  dimensions = {
    DBInstanceIdentifier = {{#if create_cluster}}aws_rds_cluster_instance.main[0].identifier{{else}}aws_db_instance.main[0].identifier{{/if}}
  }

  tags = {{#if tags}}{{tf_map tags}}{{else}}{
    Name        = "{{project_name}}-rds-memory-alarm"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }{{/if}}
}
{{/if}}

# Outputs
output "db_instance_endpoint" {
  description = "The connection endpoint"
  value       = {{#if create_cluster}}aws_rds_cluster.main[0].endpoint{{else}}aws_db_instance.main[0].address{{/if}}
}

output "db_instance_port" {
  description = "The database port"
  value       = {{#if create_cluster}}aws_rds_cluster.main[0].port{{else}}aws_db_instance.main[0].port{{/if}}
}

output "db_instance_name" {
  description = "The database name"
  value       = "{{db_name}}"
}

output "db_instance_username" {
  description = "The master username"
  value       = "{{db_username}}"
  sensitive   = true
}

{{#if create_cluster}}
output "db_cluster_id" {
  description = "The RDS cluster ID"
  value       = aws_rds_cluster.main[0].id
}

output "db_cluster_arn" {
  description = "The RDS cluster ARN"
  value       = aws_rds_cluster.main[0].arn
}

output "db_cluster_reader_endpoint" {
  description = "The cluster reader endpoint"
  value       = aws_rds_cluster.main[0].reader_endpoint
}
{{else}}
output "db_instance_id" {
  description = "The RDS instance ID"
  value       = aws_db_instance.main[0].id
}

output "db_instance_arn" {
  description = "The RDS instance ARN"
  value       = aws_db_instance.main[0].arn
}
{{/if}}

output "db_security_group_id" {
  description = "The security group ID of the RDS instance"
  value       = aws_security_group.rds.id
}

output "db_secret_arn" {
  description = "The ARN of the secret containing DB credentials"
  value       = aws_secretsmanager_secret.db_password.arn
}

# Variables
variable "vpc_id" {
  description = "VPC ID where the database will be created"
  type        = string
}

variable "private_subnet_ids" {
  description = "List of private subnet IDs for the database"
  type        = list(string)
}

variable "app_security_group_id" {
  description = "Security group ID of the application that will access the database"
  type        = string
}
