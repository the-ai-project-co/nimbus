# KMS Key Configuration for {{project_name}}
# Provider: AWS
# Component: KMS
# Generated by Nimbus Generator Service

terraform {
  required_version = ">= 1.0"

  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

# Data sources
data "aws_caller_identity" "current" {}
data "aws_partition" "current" {}

# KMS Key
resource "aws_kms_key" "main" {
  description             = "{{description}}"
  deletion_window_in_days = {{deletion_window_in_days}}
  enable_key_rotation     = {{enable_key_rotation}}
  is_enabled              = true
  {{#if multi_region}}
  multi_region            = true
  {{/if}}

  policy = jsonencode({
    Version = "2012-10-17"
    Id      = "{{project_name}}-{{key_alias}}-policy"
    Statement = [
      # Allow root account full access
      {
        Sid    = "EnableRootAccountAccess"
        Effect = "Allow"
        Principal = {
          AWS = "arn:${data.aws_partition.current.partition}:iam::${data.aws_caller_identity.current.account_id}:root"
        }
        Action   = "kms:*"
        Resource = "*"
      },
      {{#if key_admins}}
      # Allow key administrators
      {
        Sid    = "AllowKeyAdministration"
        Effect = "Allow"
        Principal = {
          AWS = {{tf_list key_admins}}
        }
        Action = [
          "kms:Create*",
          "kms:Describe*",
          "kms:Enable*",
          "kms:List*",
          "kms:Put*",
          "kms:Update*",
          "kms:Revoke*",
          "kms:Disable*",
          "kms:Get*",
          "kms:Delete*",
          "kms:TagResource",
          "kms:UntagResource",
          "kms:ScheduleKeyDeletion",
          "kms:CancelKeyDeletion",
          "kms:ReplicateKey",
          "kms:ImportKeyMaterial"
        ]
        Resource = "*"
      },
      {{/if}}
      {{#if key_users}}
      # Allow key usage
      {
        Sid    = "AllowKeyUsage"
        Effect = "Allow"
        Principal = {
          AWS = {{tf_list key_users}}
        }
        Action = [
          "kms:Encrypt",
          "kms:Decrypt",
          "kms:ReEncrypt*",
          "kms:GenerateDataKey*",
          "kms:DescribeKey"
        ]
        Resource = "*"
      },
      # Allow attachment of persistent resources (e.g., grants for AWS services)
      {
        Sid    = "AllowAttachmentOfPersistentResources"
        Effect = "Allow"
        Principal = {
          AWS = {{tf_list key_users}}
        }
        Action = [
          "kms:CreateGrant",
          "kms:ListGrants",
          "kms:RevokeGrant"
        ]
        Resource = "*"
        Condition = {
          Bool = {
            "kms:GrantIsForAWSResource" = "true"
          }
        }
      },
      {{/if}}
      {{#if allow_service_access}}
      # Allow AWS services to use the key
      {
        Sid    = "AllowServiceAccess"
        Effect = "Allow"
        Principal = {
          Service = {{tf_list allowed_services}}
        }
        Action = [
          "kms:Encrypt",
          "kms:Decrypt",
          "kms:ReEncrypt*",
          "kms:GenerateDataKey*",
          "kms:DescribeKey",
          "kms:CreateGrant"
        ]
        Resource = "*"
      },
      {{/if}}
    ]
  })

  tags = {{#if tags}}{{tf_map tags}}{{else}}{
    Name        = "{{project_name}}-{{key_alias}}"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }{{/if}}
}

# KMS Key Alias
resource "aws_kms_alias" "main" {
  name          = "alias/{{project_name}}-{{key_alias}}"
  target_key_id = aws_kms_key.main.key_id
}

{{#if create_replica_key}}
# KMS Replica Key (for multi-region keys)
resource "aws_kms_replica_key" "replica" {
  description             = "Replica of {{project_name}}-{{key_alias}} in {{replica_region}}"
  deletion_window_in_days = {{deletion_window_in_days}}
  primary_key_arn         = aws_kms_key.main.arn

  tags = {{#if tags}}{{tf_map tags}}{{else}}{
    Name        = "{{project_name}}-{{key_alias}}-replica"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }{{/if}}
}

resource "aws_kms_alias" "replica" {
  name          = "alias/{{project_name}}-{{key_alias}}-replica"
  target_key_id = aws_kms_replica_key.replica.key_id
}
{{/if}}

{{#if enable_cloudwatch_alarms}}
# CloudWatch Alarm for KMS Key Usage
resource "aws_cloudwatch_metric_alarm" "key_usage" {
  alarm_name          = "{{project_name}}-kms-{{key_alias}}-usage"
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = "1"
  metric_name         = "KeyUsage"
  namespace           = "AWS/KMS"
  period              = "300"
  statistic           = "Sum"
  threshold           = "{{key_usage_alarm_threshold}}"
  alarm_description   = "KMS key usage exceeds threshold for {{project_name}}-{{key_alias}}"
  alarm_actions       = {{#if sns_topic_arn}}["{{sns_topic_arn}}"]{{else}}[]{{/if}}

  dimensions = {
    KeyId = aws_kms_key.main.key_id
  }

  tags = {{#if tags}}{{tf_map tags}}{{else}}{
    Name        = "{{project_name}}-kms-usage-alarm"
    Environment = "{{environment}}"
    ManagedBy   = "Terraform"
  }{{/if}}
}
{{/if}}

# Outputs
output "key_id" {
  description = "The globally unique identifier for the KMS key"
  value       = aws_kms_key.main.key_id
}

output "key_arn" {
  description = "The ARN of the KMS key"
  value       = aws_kms_key.main.arn
}

output "alias_arn" {
  description = "The ARN of the KMS key alias"
  value       = aws_kms_alias.main.arn
}

output "alias_name" {
  description = "The display name of the KMS key alias"
  value       = aws_kms_alias.main.name
}

output "key_rotation_enabled" {
  description = "Whether key rotation is enabled"
  value       = aws_kms_key.main.enable_key_rotation
}

{{#if create_replica_key}}
output "replica_key_arn" {
  description = "The ARN of the replica KMS key"
  value       = aws_kms_replica_key.replica.arn
}
{{/if}}
