{{!-- GCP Cloud Storage Template --}}
# Cloud Storage Configuration
# Generated by Nimbus

terraform {
  required_version = ">= 1.0"

  required_providers {
    google = {
      source  = "hashicorp/google"
      version = "~> 5.0"
    }
  }
}

provider "google" {
  project = var.project_id
  region  = var.region
}

# Cloud Storage Bucket
resource "google_storage_bucket" "{{name}}" {
  name          = "{{#if bucketName}}{{bucketName}}{{else}}${var.project_id}-{{name}}{{/if}}"
  location      = "{{#if location}}{{location}}{{else}}US{{/if}}"
  storage_class = "{{#if storageClass}}{{storageClass}}{{else}}STANDARD{{/if}}"

  uniform_bucket_level_access = {{#if uniformBucketLevelAccess}}true{{else}}true{{/if}}

  {{#if versioning}}
  versioning {
    enabled = true
  }
  {{/if}}

  {{#if lifecycleRules}}
  {{#each lifecycleRules}}
  lifecycle_rule {
    condition {
      {{#if age}}
      age = {{age}}
      {{/if}}
      {{#if createdBefore}}
      created_before = "{{createdBefore}}"
      {{/if}}
      {{#if numNewerVersions}}
      num_newer_versions = {{numNewerVersions}}
      {{/if}}
      {{#if withState}}
      with_state = "{{withState}}"
      {{/if}}
    }
    action {
      type          = "{{action.type}}"
      {{#if action.storageClass}}
      storage_class = "{{action.storageClass}}"
      {{/if}}
    }
  }
  {{/each}}
  {{else}}
  # Default lifecycle rules
  lifecycle_rule {
    condition {
      age = 90
    }
    action {
      type          = "SetStorageClass"
      storage_class = "NEARLINE"
    }
  }

  lifecycle_rule {
    condition {
      age = 365
    }
    action {
      type          = "SetStorageClass"
      storage_class = "COLDLINE"
    }
  }
  {{/if}}

  {{#if retention}}
  retention_policy {
    is_locked        = {{#if retention.isLocked}}true{{else}}false{{/if}}
    retention_period = {{retention.retentionPeriod}}
  }
  {{/if}}

  {{#if encryption}}
  encryption {
    default_kms_key_name = {{#if encryption.kmsKeyName}}"{{encryption.kmsKeyName}}"{{else}}var.kms_key_name{{/if}}
  }
  {{/if}}

  {{#if cors}}
  {{#each cors}}
  cors {
    origin          = [{{#each origin}}"{{this}}"{{#unless @last}}, {{/unless}}{{/each}}]
    method          = [{{#each method}}"{{this}}"{{#unless @last}}, {{/unless}}{{/each}}]
    response_header = [{{#each responseHeader}}"{{this}}"{{#unless @last}}, {{/unless}}{{/each}}]
    max_age_seconds = {{#if maxAgeSeconds}}{{maxAgeSeconds}}{{else}}3600{{/if}}
  }
  {{/each}}
  {{/if}}

  {{#if website}}
  website {
    main_page_suffix = "{{#if website.mainPageSuffix}}{{website.mainPageSuffix}}{{else}}index.html{{/if}}"
    not_found_page   = "{{#if website.notFoundPage}}{{website.notFoundPage}}{{else}}404.html{{/if}}"
  }
  {{/if}}

  {{#if logging}}
  logging {
    log_bucket        = "{{logging.logBucket}}"
    log_object_prefix = "{{#if logging.logObjectPrefix}}{{logging.logObjectPrefix}}{{else}}{{name}}/{{/if}}"
  }
  {{/if}}

  labels = var.labels

  force_destroy = {{#if forceDestroy}}true{{else}}false{{/if}}
}

{{#if publicAccess}}
# Make bucket publicly readable
resource "google_storage_bucket_iam_member" "{{name}}_public" {
  bucket = google_storage_bucket.{{name}}.name
  role   = "roles/storage.objectViewer"
  member = "allUsers"
}
{{/if}}

{{#each iamBindings}}
# IAM binding: {{role}}
resource "google_storage_bucket_iam_member" "{{../name}}_{{@index}}" {
  bucket = google_storage_bucket.{{../name}}.name
  role   = "{{role}}"
  member = "{{member}}"
}
{{/each}}

{{#if notification}}
# Pub/Sub notification
resource "google_storage_notification" "{{name}}" {
  bucket         = google_storage_bucket.{{name}}.name
  payload_format = "{{#if notification.payloadFormat}}{{notification.payloadFormat}}{{else}}JSON_API_V1{{/if}}"
  topic          = "{{notification.topic}}"
  event_types    = [{{#each notification.eventTypes}}"{{this}}"{{#unless @last}}, {{/unless}}{{/each}}]

  {{#if notification.objectNamePrefix}}
  object_name_prefix = "{{notification.objectNamePrefix}}"
  {{/if}}

  depends_on = [google_pubsub_topic_iam_binding.{{name}}_binding]
}

resource "google_pubsub_topic_iam_binding" "{{name}}_binding" {
  topic   = "{{notification.topic}}"
  role    = "roles/pubsub.publisher"
  members = ["serviceAccount:${data.google_storage_project_service_account.gcs_account.email_address}"]
}

data "google_storage_project_service_account" "gcs_account" {}
{{/if}}

# Variables
variable "project_id" {
  description = "GCP project ID"
  type        = string
}

variable "region" {
  description = "GCP region"
  type        = string
  default     = "{{#if region}}{{region}}{{else}}us-central1{{/if}}"
}

{{#if encryption}}
{{#unless encryption.kmsKeyName}}
variable "kms_key_name" {
  description = "KMS key name for bucket encryption"
  type        = string
}
{{/unless}}
{{/if}}

variable "labels" {
  description = "Labels to apply to resources"
  type        = map(string)
  default     = {}
}

# Outputs
output "bucket_name" {
  description = "Bucket name"
  value       = google_storage_bucket.{{name}}.name
}

output "bucket_url" {
  description = "Bucket URL"
  value       = google_storage_bucket.{{name}}.url
}

output "bucket_self_link" {
  description = "Bucket self link"
  value       = google_storage_bucket.{{name}}.self_link
}
