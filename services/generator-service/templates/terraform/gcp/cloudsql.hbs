{{!-- GCP Cloud SQL Template --}}
# Cloud SQL Configuration
# Generated by Nimbus

terraform {
  required_version = ">= 1.0"

  required_providers {
    google = {
      source  = "hashicorp/google"
      version = "~> 5.0"
    }
    random = {
      source  = "hashicorp/random"
      version = "~> 3.0"
    }
  }
}

provider "google" {
  project = var.project_id
  region  = var.region
}

# Random suffix for instance name (Cloud SQL requires globally unique names)
resource "random_id" "db_suffix" {
  byte_length = 4
}

# Cloud SQL Instance
resource "google_sql_database_instance" "{{name}}" {
  name                = "{{name}}-${random_id.db_suffix.hex}"
  database_version    = "{{#if databaseVersion}}{{databaseVersion}}{{else}}POSTGRES_15{{/if}}"
  region              = var.region
  deletion_protection = {{#if deletionProtection}}true{{else}}false{{/if}}

  settings {
    tier              = "{{#if tier}}{{tier}}{{else}}db-f1-micro{{/if}}"
    availability_type = "{{#if availabilityType}}{{availabilityType}}{{else}}ZONAL{{/if}}"
    disk_size         = {{#if diskSizeGb}}{{diskSizeGb}}{{else}}10{{/if}}
    disk_type         = "{{#if diskType}}{{diskType}}{{else}}PD_SSD{{/if}}"
    disk_autoresize   = {{#if diskAutoresize}}true{{else}}true{{/if}}

    {{#if privateNetwork}}
    ip_configuration {
      ipv4_enabled    = false
      private_network = {{#if vpcId}}{{vpcId}}{{else}}var.network_id{{/if}}
      require_ssl     = {{#if requireSsl}}true{{else}}false{{/if}}
    }
    {{else}}
    ip_configuration {
      ipv4_enabled = true
      require_ssl  = {{#if requireSsl}}true{{else}}false{{/if}}

      {{#each authorizedNetworks}}
      authorized_networks {
        name  = "{{name}}"
        value = "{{cidr}}"
      }
      {{/each}}
    }
    {{/if}}

    {{#if backupConfiguration}}
    backup_configuration {
      enabled                        = true
      start_time                     = "{{#if backupConfiguration.startTime}}{{backupConfiguration.startTime}}{{else}}03:00{{/if}}"
      point_in_time_recovery_enabled = {{#if backupConfiguration.pitr}}true{{else}}false{{/if}}
      transaction_log_retention_days = {{#if backupConfiguration.transactionLogRetentionDays}}{{backupConfiguration.transactionLogRetentionDays}}{{else}}7{{/if}}

      backup_retention_settings {
        retained_backups = {{#if backupConfiguration.retainedBackups}}{{backupConfiguration.retainedBackups}}{{else}}7{{/if}}
        retention_unit   = "COUNT"
      }
    }
    {{/if}}

    {{#if maintenanceWindow}}
    maintenance_window {
      day          = {{maintenanceWindow.day}}
      hour         = {{maintenanceWindow.hour}}
      update_track = "{{#if maintenanceWindow.updateTrack}}{{maintenanceWindow.updateTrack}}{{else}}stable{{/if}}"
    }
    {{/if}}

    {{#if insightsConfig}}
    insights_config {
      query_insights_enabled  = true
      query_string_length     = {{#if insightsConfig.queryStringLength}}{{insightsConfig.queryStringLength}}{{else}}1024{{/if}}
      record_application_tags = true
      record_client_address   = true
    }
    {{/if}}

    {{#if databaseFlags}}
    {{#each databaseFlags}}
    database_flags {
      name  = "{{name}}"
      value = "{{value}}"
    }
    {{/each}}
    {{/if}}

    user_labels = var.labels
  }

  {{#if highAvailability}}
  # Read replica settings will go here
  {{/if}}
}

# Default database
resource "google_sql_database" "{{name}}" {
  name     = "{{#if databaseName}}{{databaseName}}{{else}}{{name}}{{/if}}"
  instance = google_sql_database_instance.{{name}}.name
  charset  = "{{#if charset}}{{charset}}{{else}}UTF8{{/if}}"
}

{{#each additionalDatabases}}
# Additional database: {{name}}
resource "google_sql_database" "{{name}}" {
  name     = "{{name}}"
  instance = google_sql_database_instance.{{../name}}.name
  charset  = "{{#if charset}}{{charset}}{{else}}UTF8{{/if}}"
}
{{/each}}

# Admin user
resource "random_password" "{{name}}_admin" {
  length  = 32
  special = false
}

resource "google_sql_user" "{{name}}_admin" {
  name     = "{{#if adminUsername}}{{adminUsername}}{{else}}admin{{/if}}"
  instance = google_sql_database_instance.{{name}}.name
  password = random_password.{{name}}_admin.result
}

{{#each additionalUsers}}
# Additional user: {{name}}
resource "random_password" "{{../name}}_{{name}}" {
  length  = 32
  special = false
}

resource "google_sql_user" "{{../name}}_{{name}}" {
  name     = "{{name}}"
  instance = google_sql_database_instance.{{../name}}.name
  password = random_password.{{../name}}_{{name}}.result
}
{{/each}}

# Secret Manager for credentials
{{#if useSecretManager}}
resource "google_secret_manager_secret" "{{name}}_connection" {
  secret_id = "{{name}}-db-connection"

  replication {
    auto {}
  }
}

resource "google_secret_manager_secret_version" "{{name}}_connection" {
  secret      = google_secret_manager_secret.{{name}}_connection.id
  secret_data = jsonencode({
    host     = google_sql_database_instance.{{name}}.{{#if privateNetwork}}private_ip_address{{else}}public_ip_address{{/if}}
    port     = 5432
    database = google_sql_database.{{name}}.name
    username = google_sql_user.{{name}}_admin.name
    password = random_password.{{name}}_admin.result
  })
}
{{/if}}

# Variables
variable "project_id" {
  description = "GCP project ID"
  type        = string
}

variable "region" {
  description = "GCP region"
  type        = string
  default     = "{{#if region}}{{region}}{{else}}us-central1{{/if}}"
}

{{#if privateNetwork}}
{{#unless vpcId}}
variable "network_id" {
  description = "VPC network ID for private IP"
  type        = string
}
{{/unless}}
{{/if}}

variable "labels" {
  description = "Labels to apply to resources"
  type        = map(string)
  default     = {}
}

# Outputs
output "instance_name" {
  description = "Cloud SQL instance name"
  value       = google_sql_database_instance.{{name}}.name
}

output "instance_connection_name" {
  description = "Cloud SQL connection name"
  value       = google_sql_database_instance.{{name}}.connection_name
}

output "{{#if privateNetwork}}private{{else}}public{{/if}}_ip_address" {
  description = "Database IP address"
  value       = google_sql_database_instance.{{name}}.{{#if privateNetwork}}private_ip_address{{else}}public_ip_address{{/if}}
}

output "database_name" {
  description = "Database name"
  value       = google_sql_database.{{name}}.name
}

output "admin_username" {
  description = "Admin username"
  value       = google_sql_user.{{name}}_admin.name
}

output "admin_password" {
  description = "Admin password"
  value       = random_password.{{name}}_admin.result
  sensitive   = true
}

{{#if useSecretManager}}
output "connection_secret" {
  description = "Secret Manager secret ID containing connection details"
  value       = google_secret_manager_secret.{{name}}_connection.secret_id
}
{{/if}}
