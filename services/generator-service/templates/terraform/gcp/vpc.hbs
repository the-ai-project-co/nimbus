{{!-- GCP VPC Template --}}
# GCP VPC Configuration
# Generated by Nimbus

terraform {
  required_version = ">= 1.0"

  required_providers {
    google = {
      source  = "hashicorp/google"
      version = "~> 5.0"
    }
  }
}

provider "google" {
  project = var.project_id
  region  = var.region
}

# VPC Network
resource "google_compute_network" "{{name}}" {
  name                    = "{{name}}-vpc"
  auto_create_subnetworks = false
  routing_mode            = "{{#if routingMode}}{{routingMode}}{{else}}REGIONAL{{/if}}"

  description = "{{#if description}}{{description}}{{else}}VPC for {{name}}{{/if}}"
}

{{#each subnets}}
# Subnet: {{name}}
resource "google_compute_subnetwork" "{{name}}" {
  name          = "{{name}}"
  ip_cidr_range = "{{cidr}}"
  region        = "{{#if region}}{{region}}{{else}}var.region{{/if}}"
  network       = google_compute_network.{{../name}}.id

  {{#if secondaryRanges}}
  {{#each secondaryRanges}}
  secondary_ip_range {
    range_name    = "{{name}}"
    ip_cidr_range = "{{cidr}}"
  }
  {{/each}}
  {{/if}}

  private_ip_google_access = {{#if privateGoogleAccess}}true{{else}}false{{/if}}

  {{#if logConfig}}
  log_config {
    aggregation_interval = "{{logConfig.aggregationInterval}}"
    flow_sampling        = {{logConfig.flowSampling}}
    metadata             = "{{logConfig.metadata}}"
  }
  {{/if}}
}
{{/each}}

{{#if enableNat}}
# Cloud Router for NAT
resource "google_compute_router" "{{name}}" {
  name    = "{{name}}-router"
  region  = var.region
  network = google_compute_network.{{name}}.id

  bgp {
    asn = 64514
  }
}

# Cloud NAT
resource "google_compute_router_nat" "{{name}}" {
  name                               = "{{name}}-nat"
  router                             = google_compute_router.{{name}}.name
  region                             = var.region
  nat_ip_allocate_option             = "AUTO_ONLY"
  source_subnetwork_ip_ranges_to_nat = "ALL_SUBNETWORKS_ALL_IP_RANGES"

  log_config {
    enable = true
    filter = "ERRORS_ONLY"
  }
}
{{/if}}

{{#if enableFirewall}}
# Default firewall rules
resource "google_compute_firewall" "{{name}}_allow_internal" {
  name    = "{{name}}-allow-internal"
  network = google_compute_network.{{name}}.name

  allow {
    protocol = "icmp"
  }

  allow {
    protocol = "tcp"
    ports    = ["0-65535"]
  }

  allow {
    protocol = "udp"
    ports    = ["0-65535"]
  }

  source_ranges = [{{#each subnets}}"{{cidr}}"{{#unless @last}}, {{/unless}}{{/each}}]
}

resource "google_compute_firewall" "{{name}}_allow_ssh_iap" {
  name    = "{{name}}-allow-ssh-iap"
  network = google_compute_network.{{name}}.name

  allow {
    protocol = "tcp"
    ports    = ["22"]
  }

  # IAP IP ranges
  source_ranges = ["35.235.240.0/20"]
}
{{/if}}

# Variables
variable "project_id" {
  description = "GCP project ID"
  type        = string
}

variable "region" {
  description = "GCP region"
  type        = string
  default     = "{{#if region}}{{region}}{{else}}us-central1{{/if}}"
}

# Outputs
output "network_id" {
  description = "VPC network ID"
  value       = google_compute_network.{{name}}.id
}

output "network_name" {
  description = "VPC network name"
  value       = google_compute_network.{{name}}.name
}

output "network_self_link" {
  description = "VPC network self link"
  value       = google_compute_network.{{name}}.self_link
}

{{#each subnets}}
output "{{name}}_subnet_id" {
  description = "{{name}} subnet ID"
  value       = google_compute_subnetwork.{{name}}.id
}
{{/each}}
