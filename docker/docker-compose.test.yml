# Nimbus Test Docker Compose
# CI/CD and integration testing environment

version: '3.8'

services:
  # Test runner service
  test-runner:
    build:
      context: ..
      dockerfile: docker/Dockerfile.base
    container_name: nimbus-test-runner
    environment:
      - NODE_ENV=test
      - CI=true
      - CORE_ENGINE_URL=http://core-engine:3001
      - LLM_SERVICE_URL=http://llm:3002
      - GENERATOR_SERVICE_URL=http://generator:3003
      - STATE_SERVICE_URL=http://state:3004
    volumes:
      - ..:/app
      - /app/node_modules
    command: bun test
    depends_on:
      core-engine:
        condition: service_healthy
      llm:
        condition: service_healthy
      generator:
        condition: service_healthy
      state:
        condition: service_healthy
    networks:
      - nimbus-test-network

  # Core services for integration tests
  core-engine:
    build:
      context: ..
      dockerfile: docker/Dockerfile.core-engine
    container_name: nimbus-core-engine-test
    environment:
      - NODE_ENV=test
      - PORT=3001
      - LLM_SERVICE_URL=http://llm:3002
      - GENERATOR_SERVICE_URL=http://generator:3003
      - STATE_SERVICE_URL=http://state:3004
    networks:
      - nimbus-test-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 5s

  llm:
    build:
      context: ..
      dockerfile: docker/Dockerfile.llm
    container_name: nimbus-llm-test
    environment:
      - NODE_ENV=test
      - PORT=3002
      - MOCK_LLM=true  # Use mock responses for testing
    networks:
      - nimbus-test-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3002/health"]
      interval: 5s
      timeout: 5s
      retries: 10

  generator:
    build:
      context: ..
      dockerfile: docker/Dockerfile.generator
    container_name: nimbus-generator-test
    environment:
      - NODE_ENV=test
      - PORT=3003
      - LLM_SERVICE_URL=http://llm:3002
    depends_on:
      llm:
        condition: service_healthy
    networks:
      - nimbus-test-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3003/health"]
      interval: 5s
      timeout: 5s
      retries: 10

  state:
    build:
      context: ..
      dockerfile: docker/Dockerfile.state
    container_name: nimbus-state-test
    environment:
      - NODE_ENV=test
      - PORT=3004
      - DATABASE_PATH=:memory:  # Use in-memory SQLite for tests
    networks:
      - nimbus-test-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3004/health"]
      interval: 5s
      timeout: 5s
      retries: 10

  # Mock MCP tools services for testing
  terraform:
    build:
      context: ..
      dockerfile: docker/Dockerfile.terraform
    container_name: nimbus-terraform-test
    environment:
      - NODE_ENV=test
      - PORT=3005
      - MOCK_TERRAFORM=true
    networks:
      - nimbus-test-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3005/health"]
      interval: 5s
      timeout: 5s
      retries: 10

  k8s:
    build:
      context: ..
      dockerfile: docker/Dockerfile.k8s
    container_name: nimbus-k8s-test
    environment:
      - NODE_ENV=test
      - PORT=3006
      - MOCK_K8S=true
    networks:
      - nimbus-test-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3006/health"]
      interval: 5s
      timeout: 5s
      retries: 10

  helm:
    build:
      context: ..
      dockerfile: docker/Dockerfile.helm
    container_name: nimbus-helm-test
    environment:
      - NODE_ENV=test
      - PORT=3007
      - MOCK_HELM=true
    networks:
      - nimbus-test-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3007/health"]
      interval: 5s
      timeout: 5s
      retries: 10

networks:
  nimbus-test-network:
    driver: bridge
