# Nimbus Development Docker Compose
# Local development with hot reloading and debugging

version: '3.8'

services:
  # Core Services with hot reload
  core-engine:
    build:
      context: ..
      dockerfile: docker/Dockerfile.core-engine
      target: builder
    container_name: nimbus-core-engine-dev
    ports:
      - "3001:3001"
      - "9229:9229"  # Debug port
    environment:
      - NODE_ENV=development
      - PORT=3001
      - DEBUG=nimbus:*
      - LLM_SERVICE_URL=http://llm:3002
      - GENERATOR_SERVICE_URL=http://generator:3003
      - STATE_SERVICE_URL=http://state:3004
    volumes:
      - ../services/core-engine-service:/app/services/core-engine-service
      - ../shared:/app/shared
      - /app/node_modules
    command: bun --watch run src/index.ts
    networks:
      - nimbus-dev-network

  llm:
    build:
      context: ..
      dockerfile: docker/Dockerfile.llm
      target: builder
    container_name: nimbus-llm-dev
    ports:
      - "3002:3002"
    environment:
      - NODE_ENV=development
      - PORT=3002
      - DEBUG=nimbus:*
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
    volumes:
      - ../services/llm-service:/app/services/llm-service
      - ../shared:/app/shared
      - /app/node_modules
    command: bun --watch run src/index.ts
    networks:
      - nimbus-dev-network

  generator:
    build:
      context: ..
      dockerfile: docker/Dockerfile.generator
      target: builder
    container_name: nimbus-generator-dev
    ports:
      - "3003:3003"
    environment:
      - NODE_ENV=development
      - PORT=3003
      - DEBUG=nimbus:*
      - LLM_SERVICE_URL=http://llm:3002
    volumes:
      - ../services/generator-service:/app/services/generator-service
      - ../shared:/app/shared
      - /app/node_modules
    command: bun --watch run src/index.ts
    depends_on:
      - llm
    networks:
      - nimbus-dev-network

  state:
    build:
      context: ..
      dockerfile: docker/Dockerfile.state
      target: builder
    container_name: nimbus-state-dev
    ports:
      - "3004:3004"
    environment:
      - NODE_ENV=development
      - PORT=3004
      - DEBUG=nimbus:*
      - DATABASE_PATH=/app/data/nimbus-dev.db
    volumes:
      - ../services/state-service:/app/services/state-service
      - ../shared:/app/shared
      - nimbus-dev-data:/app/data
      - /app/node_modules
    command: bun --watch run src/index.ts
    networks:
      - nimbus-dev-network

  # MCP Tools Services (minimal for development)
  terraform:
    build:
      context: ..
      dockerfile: docker/Dockerfile.terraform
      target: builder
    container_name: nimbus-terraform-dev
    ports:
      - "3005:3005"
    environment:
      - NODE_ENV=development
      - PORT=3005
      - DEBUG=nimbus:*
    volumes:
      - ../services/terraform-tools-service:/app/services/terraform-tools-service
      - ../shared:/app/shared
      - ./workspaces:/app/workspaces
      - /app/node_modules
    command: bun --watch run src/index.ts
    networks:
      - nimbus-dev-network

  k8s:
    build:
      context: ..
      dockerfile: docker/Dockerfile.k8s
      target: builder
    container_name: nimbus-k8s-dev
    ports:
      - "3006:3006"
    environment:
      - NODE_ENV=development
      - PORT=3006
      - DEBUG=nimbus:*
      - KUBECONFIG=/app/.kube/config
    volumes:
      - ../services/k8s-tools-service:/app/services/k8s-tools-service
      - ../shared:/app/shared
      - ${HOME}/.kube:/app/.kube:ro
      - /app/node_modules
    command: bun --watch run src/index.ts
    networks:
      - nimbus-dev-network

  helm:
    build:
      context: ..
      dockerfile: docker/Dockerfile.helm
      target: builder
    container_name: nimbus-helm-dev
    ports:
      - "3007:3007"
    environment:
      - NODE_ENV=development
      - PORT=3007
      - DEBUG=nimbus:*
      - KUBECONFIG=/app/.kube/config
    volumes:
      - ../services/helm-tools-service:/app/services/helm-tools-service
      - ../shared:/app/shared
      - ${HOME}/.kube:/app/.kube:ro
      - /app/node_modules
    command: bun --watch run src/index.ts
    networks:
      - nimbus-dev-network

  git:
    build:
      context: ..
      dockerfile: docker/Dockerfile.git
      target: builder
    container_name: nimbus-git-dev
    ports:
      - "3008:3008"
    environment:
      - NODE_ENV=development
      - PORT=3008
      - DEBUG=nimbus:*
    volumes:
      - ../services/git-tools-service:/app/services/git-tools-service
      - ../shared:/app/shared
      - ${HOME}/.ssh:/home/nimbus/.ssh:ro
      - ./workspaces:/app/workspaces
      - /app/node_modules
    command: bun --watch run src/index.ts
    networks:
      - nimbus-dev-network

  github:
    build:
      context: ..
      dockerfile: docker/Dockerfile.github
      target: builder
    container_name: nimbus-github-dev
    ports:
      - "3009:3009"
    environment:
      - NODE_ENV=development
      - PORT=3009
      - DEBUG=nimbus:*
      - GITHUB_TOKEN=${GITHUB_TOKEN}
    volumes:
      - ../services/github-tools-service:/app/services/github-tools-service
      - ../shared:/app/shared
      - /app/node_modules
    command: bun --watch run src/index.ts
    networks:
      - nimbus-dev-network

  aws:
    build:
      context: ..
      dockerfile: docker/Dockerfile.aws
      target: builder
    container_name: nimbus-aws-dev
    ports:
      - "3010:3010"
    environment:
      - NODE_ENV=development
      - PORT=3010
      - DEBUG=nimbus:*
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-1}
    volumes:
      - ../services/aws-tools-service:/app/services/aws-tools-service
      - ../shared:/app/shared
      - ${HOME}/.aws:/home/nimbus/.aws:ro
      - /app/node_modules
    command: bun --watch run src/index.ts
    networks:
      - nimbus-dev-network

  fs:
    build:
      context: ..
      dockerfile: docker/Dockerfile.fs
      target: builder
    container_name: nimbus-fs-dev
    ports:
      - "3011:3011"
    environment:
      - NODE_ENV=development
      - PORT=3011
      - DEBUG=nimbus:*
    volumes:
      - ../services/fs-tools-service:/app/services/fs-tools-service
      - ../shared:/app/shared
      - ./workspaces:/app/workspaces
      - /app/node_modules
    command: bun --watch run src/index.ts
    networks:
      - nimbus-dev-network

networks:
  nimbus-dev-network:
    driver: bridge

volumes:
  nimbus-dev-data:
    driver: local
